<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC</title>
  </head>

  <body>
    <div id="video-container"></div>

    <script>
      const container = document.getElementById("video-container");
      const pc = new RTCPeerConnection();
      pc.addTransceiver("video", { direction: "recvonly" });

      pc.ontrack = (event) => {
        console.log(event);
        const video = document.createElement("video");
        video.srcObject = event.streams[0];
        video.autoplay = true;
        video.controls = true;
        container.appendChild(video);
      };

      async function start() {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        await new Promise((resolve) => {
          if (pc.iceGatheringState === "complete") {
            resolve();
          } else {
            const checkState = () => {
              if (pc.iceGatheringState === "complete") {
                pc.removeEventListener("icegatheringstatechange", checkState);
                resolve();
              }
            };
            pc.addEventListener("icegatheringstatechange", checkState);
          }
        });

        const response = await fetch("http://localhost:9000/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type,
          }),
        });

        const answer = await response.json();
        await pc.setRemoteDescription(answer);
      }

      start()
        .then(() => console.log("done"))
        .catch(console.error);
    </script>
  </body>
</html>
